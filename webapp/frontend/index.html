<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YOLO Detector</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <div class="page">
    <div class="card">
      <h1>YOLO Detector <span>Upload</span></h1>
      <p>Chọn một ảnh, gửi lên API FastAPI. Mô hình YOLO sẽ phát hiện và trả về bounding box.</p>
      <div class="upload">
        <label for="file">
          <div>
            <div>Chọn hoặc kéo thả ảnh</div>
            <div class="muted">PNG, JPG được hỗ trợ</div>
          </div>
          <div class="badge">Browse</div>
        </label>
        <input id="file" type="file" accept="image/*" />
      </div>
      <button id="submit">Detect</button>
      <div class="badges">
        <div class="badge" id="status">Idle</div>
        <div class="badge" id="size"></div>
      </div>
    </div>

    <div class="card">
      <h1>Preview <span>Input</span></h1>
      <div class="preview" id="preview-box">
        <div class="muted">Chưa có ảnh</div>
        <img id="preview" alt="" style="display:none;" />
      </div>
    </div>

    <div class="card">
      <h1>Kết quả <span>YOLO</span></h1>
      <div class="result" id="result-box">
        <div class="muted" id="result-placeholder">Chưa có kết quả</div>
        <div class="spinner" id="loading" style="display:none;"></div>
        <img id="annotated" alt="Detection result" style="display:none;" />
      </div>
      <div class="list" id="boxes"></div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('file');
    const preview = document.getElementById('preview');
    const annotated = document.getElementById('annotated');
    const statusBadge = document.getElementById('status');
    const sizeBadge = document.getElementById('size');
    const loading = document.getElementById('loading');
    const resultPlaceholder = document.getElementById('result-placeholder');
    const boxesList = document.getElementById('boxes');
    const submitBtn = document.getElementById('submit');

    fileInput.addEventListener('change', () => {
      const file = fileInput.files?.[0];
      if (!file) return;
      preview.src = URL.createObjectURL(file);
      preview.style.display = 'block';
      statusBadge.textContent = 'Ready';
      sizeBadge.textContent = `${(file.size / 1024).toFixed(1)} KB`;
      document.getElementById('preview-box').querySelector('.muted')?.remove();
    });

    async function detect() {
      const file = fileInput.files?.[0];
      if (!file) {
        alert('Vui lòng chọn ảnh trước.');
        return;
      }
      statusBadge.textContent = 'Uploading...';
      loading.style.display = 'grid';
      resultPlaceholder.style.display = 'none';
      annotated.style.display = 'none';
      boxesList.innerHTML = '';

      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch('/api/detect', { method: 'POST', body: formData });
        if (!res.ok) {
          const msg = await res.json().catch(() => ({}));
          throw new Error(msg.detail || 'Detect failed');
        }
        const data = await res.json();
        annotated.src = data.annotated_image;
        annotated.style.display = 'block';
        statusBadge.textContent = 'Done';
        boxesList.innerHTML = '';
        (data.boxes || []).forEach((b, idx) => {
          const item = document.createElement('div');
          item.className = 'item';
          const name = b.class_name ?? 'unknown';
          const conf = b.confidence !== null && b.confidence !== undefined ? `${(b.confidence * 100).toFixed(1)}%` : '--';
          const indexLabel = b.index ?? idx + 1;
          item.innerHTML = `<span>${indexLabel}. ${name}</span><div class="muted">${conf}</div>`;
          boxesList.appendChild(item);
        });
      } catch (err) {
        statusBadge.textContent = 'Error';
        alert(err.message || 'Có lỗi xảy ra');
      } finally {
        loading.style.display = 'none';
      }
    }

    submitBtn.addEventListener('click', detect);
  </script>
</body>
</html>
